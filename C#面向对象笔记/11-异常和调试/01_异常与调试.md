## 本节目标
1. Exception：异常类
2. try-catch-finally捕获并处理异常

## 异常与调试


在编程中不可避免地会出现一些错误，错误主要包括编译错误、运行错误和逻辑错误。

编译错误是很容易发现的，在 Visual Studio 2019 的代码页面中若出现一些红色的波浪线，表示程序无法运行；而逻辑错误是很难发现的，通常需要借助调试工具来查找。

此外，程序在运行过程中也会出现一些不可预料的问题，例如将字符串类型转换成整数时出现的异常、除数为 0 等。

在 C# 语言中，异常也称为运行时异常，它是在程序运行过程中出现的错误。

对于异常的处理需要程序员积累经验，在可能出现异常的位置加入异常处理语句。


## 异常类：Exception


.NET Framework 类库中的所有异常都派生于 Exception 类，异常包括系统异常和应用异常。

默认所有系统异常派生于 **System.SystemException**，所有的应用程序异常派生于 **System.ApplicationException**。

系统异常包括 OutOfMemoryException、IOException、NullReferenceException等。

常用的系统异常类如下表所示。

|**异常类**|**说明**|
|------|------|
|System.OutOfMemoryException	|用 new 分配内存失败|
|System.StackOverflowException	|递归过多、过深|
|System.NullReferenceException	|对象为空|
|Syetem.IndexOutOfRangeException	|数组越界|
|System.ArithmaticException	|算术操作异常的基类|
|System.DivideByZeroException	|除零错误|



## 异常处理：try-catch-finally

C#提供了3种异常处理结构：

```c#
try-catch
try-finally
try-catch-finally
```

在上述三种异常处理的形式中所用到关键字其含义如下：

```C#
1. try：用于捕捉块执行过程中发生的异常,可能发生异常的代码放在该语句块中
2. catch：处理异常，可以有多个 catch 子句。 
3. finally：放在最后，一般用于释放资源。无论是否引发了异常，finally 的代码块都将被执行。 
```

### try catch

在 try 语句中放置可能出现异常的语句，而在 catch 语句中放置异常时处理异常的语句，通常在 catch 语句中输出异常信息或者发送邮件给开发人员等。

```c#
	try{
		可能出现异常的语句
	}
	catch{
		异常时处理异常的语句
	}
```

下面通过实例来演示 try catch 的应用。

另外，在处理异常时，catch 语句是允许多次使用的，相当于多分支的 if 语句，仅能执行其中一个分支。

**【实例 1】在控制台输入一个整数，并判断其是否大于 100。**

根据题目要求，如果在控制台输入的是一个字符串或者浮点数，就会出现类型转换错误;“输入字符串格式不正确”的异常提示

如果使用异常处理的语句来处理数据类型转换，则不会岀现上图中的提示，而是捕获异常后在 catch 语句中处理异常，实现的代码如下。

```C#
        class Program
		{
			static void Main(string[] args)
			{
				try
				{
                    //try块会先运行
                    //如果没出现错误，会跳过catch块运行下面的部分
                    //如果出现错误所以会跳过其余的程序运行到catch块执行，然后继续下去。
					int a = int.Parse(Console.ReadLine());
					Console.WriteLine("输入的数字为："+a);
				}
				catch (Exception e)
				{
					//catch块的代码，只有当try块代码出错会被运行，没有错不会被运行
					Console.WriteLine(e.Message);
				}
				Console.ReadKey();
			}
		}
```



**【实例 2】使用多个 catch 语句对程序做异常处理。**

从控制台输入 5 个数存入整数数组中，首先判断输入的值是否为数值，再判断数组元素是否越界。

根据题目要求，创建控制台应用程序完成该实例，具体的代码如下。

```C#
    class Program
    {
        static void Main(string[] args)
        {
            //定义存放5个整数的数组
            int[] a = new int[5];
            try
            {
                for(int i = 0; i < a.Length; i++)
                {
                    a[i] = int.Parse(Console.ReadLine());
                }
                for(int i = 0; i < a.Length; i++)
                {
                    Console.Write(a[i] + " ");
                }
            }
            catch(FormatException f)
            {
                Console.WriteLine("输入的数字格式不正确！");
            }
            catch(OverflowException o)
            {
                Console.WriteLine("输入的值已经超出 int 类型的最大值！");
            }
            catch(IndexOutOfRangeException r)
            {
                Console.WriteLine("数组越界异常！");
            }
        }
    }
```



这样，在出现不同的异常时都会有相应的异常类来处理异常，这也是比较推荐的一种编程方法。

### **try finally**

在 try finally 形式中没有单独对出现异常时处理的代码，**finally 语句是无论 try 中的语句是否正确执行都会执行的语句**。

通常在 finally 中编写的代码是关闭流、关闭数据库连接等操作，以免造成资源的浪费。

下面通过实例来演示 try finally 形式的应用。

**【实例 3】验证 finally 语句的使用。**

将实例 1 中的 catch 语句替换成 finally 语句，代码如下。

```c#
        class Program
        {
            static void Main(string[] args)
            {
                try
                {
                    int a = int.Parse(Console.ReadLine());
                    Console.WriteLine("输入的数字为："+a);
                }
          
                finally
                {
                    //无论是否异常都会执行finally块的代码
                    Console.WriteLine("释放资源");
                }
                Console.ReadKey();
            }
        }
```



使用try finally，当控制台中输入的值是一个数字字符串时也会执行 finally 语句中的内容。

### try catch finally

try catch finally 形式语句是使用最多的一种异常处理语句。

在出现异常时能提供相应的异常处理，并能在 finally 语句中保证资源的回收。

**【实例 3】try catch finally语句的使用。**

```C#
 		class Program
        {
            static void Main(string[] args)
            {
                try
                {
                    int a = int.Parse(Console.ReadLine());
                    Console.WriteLine("输入的数字为："+a);
                }
                catch (Exception e)
                {

                	Console.WriteLine(e.Message);
                }
                finally
                {
                    Console.WriteLine("释放资源");
                }
                Console.ReadKey();
            }
        }
```




## 自定义异常（throw抛出异常）


虽然在 C# 语言中已经提供了很多异常处理类，但在实际编程中还是会遇到未涉及的一些异常处理。

例如想将数据的验证放置到异常处理中，即判断所输入的年龄必须为 18〜45，此时需要自定义异常类来实现。

**自定义异常类必须要继承 Exception 类。**

声明异常的语句如下。

```C#
    class 异常类名 :Exception
    {
    }
```

抛出自己的异常，语句如下

```C#
    throw( new 异常类名(异常信息) );
```

下面通过实例来演示自定义异常的应用。

**【实例4】自定义异常类，判断从文本框中输入的年龄值处于 18〜45。**

编写自定义异常类，代码如下。

```C#
    class MyException :Exception
    {
        public MyException(string message) : base(message)
        {
        }
    }
```

在主方法中根据输入的年龄判断是否抛出自定义异常，代码如下。

```C#
   		static void Main(string[] args)
        {
            try
            {
                int age = int.Parse(Console.ReadLine());
                if (age < 18 || age > 45)
                {
                    //在try代码块中用throw关键字抛出自定义异常对象
                    throw new MyException("年龄必须在18~45岁之间！");
                }
                else
                {
                    Console.WriteLine("输入的年龄正确！"); 
                }
            }
            catch (MyException myException)
            {
                Console.WriteLine(myException.Message);
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
               
            }

        }
```

使用自定义异常后，若在控制台输入的年龄不在 18〜45 岁即会抛出自定的异常。

自定义异常也继承自 Exception 类，因此如果不直接处理 MyException 异常，也可以直接使用 Exception 类来处理该异常。






## 程序调试

当程序出现逻辑性错误，运行结果与预期结果不同时，可以进行程序的单步调试，查找出问题点。

使用设置断点、监视断点，以及逐语句、逐过程、使用一些辅助窗口来调试程序。

 **程序的调试过程**

1. 设置断点：鼠标直接单击左边的
2. 运行程序（可以直接按 F5 键）
3. 调试程序
4. 监视变量

**常用的调试命令**
逐语句（逐语句）：按 F11 键也可以，用于逐条语句运行。
逐过程（逐过程）：按 F10 键也可以，过程是指可以将方法作为一个整体去执行，不会跳进方法中执行。
跳出（跳出）：按 Shift+F11 组合键也可以，跳出是将程序的调试状态结束，并结束整个程序。



## 总结

1. 通过try-catch-finally完成异常的捕获和处理，通常是处理程序运行中的错误
2. try代码块中编写的是可能出现异常的程序代码，最先被执行。代码一旦发生异常，在异常代码后的其余部分不会被执行，直接跳转到catch代码块。
3. catch代码块编写的是处理异常的代码，只有try中的代码发生异常才会被执行。
4. finally代码块中通常编写的是释放资源的代码，无论是否发生异常都后被执行。
5. 用throw关键字抛出自定义异常
6. 通过程序调试可以观察程序运行中变量的值，从而发现逻辑问题并解决。





